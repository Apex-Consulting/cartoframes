async function initialize() {
  const basemap = '{{ basemap }}';
  const bounds = {{ bounds }};
  const camera = {{ camera|tojson }};
  const layersDef = {{ layers|tojson }};

  let credentials = null;
  let layer = null;
  let source = null;
  let style = null;

  const deckMap = carto.viz.createMap({
    basemap: basemap,
    initialViewState: camera
  });

  for (const layerDef of layersDef) {
    if (layerDef.type === 'Query') {
        credentials = new carto.Credentials(layerDef.credentials.username, layerDef.credentials.api_key, layerDef.credentials.base_url);
        source = new carto.viz.CARTOSource(layerDef.data, {credentials});

    } else {
        source = new carto.viz.GeoJsonSource(layerDef.data);
    }

    if (!!layerDef.viz && !!layerDef.viz.value) {
      style = carto.viz[layerDef.viz.name](layerDef.viz.value, layerDef.viz.options);

    } else if (!!layerDef.viz) {
      style = carto.viz[layerDef.viz.name](layerDef.viz.options);
    }

    layer = new carto.viz.Layer(source, style);

    if (!!layerDef.interactivity.hover) {
      await layer.setPopupHover(layerDef.interactivity.hover);
    }

    if (!!layerDef.interactivity.click) {
      await layer.setPopupClick(layerDef.interactivity.click);
    }

    await layer.addTo(deckMap);
  }

  const {viewport} = deckMap.layerManager.context;
  const {longitude, latitude, zoom} = viewport.fitBounds(bounds);
  const viewState = Object.assign({}, {longitude, latitude, zoom}, camera);

  deckMap.viewManager.setProps({
    viewState: viewState
  });
}

initialize();
